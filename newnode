# 使用官方的 Golang 镜像作为基础镜像
FROM golang:1.21.8

# 安装依赖项
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    jq \
    gcc \
    snapd \
    chrony \
    lz4 \
    tmux \
    unzip \
    bc && \
    rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /root

# 安装 Airchains
RUN wget https://github.com/airchains-network/junction/releases/download/v0.1.0/junctiond && \
    chmod +x junctiond && \
    mv junctiond /usr/local/bin/

# 设置环境变量
ENV GOROOT=/usr/local/go \
    GOPATH=/root/go \
    GO111MODULE=on \
    PATH=$PATH:/usr/local/go/bin:/root/go/bin

# 验证 Airchains 安装
RUN junctiond version

# 下载 Genesis 和地址簿
RUN mkdir -p /root/.junction/config && \
    curl -Ls https://node39.top/testnet/airchains/genesis.json > /root/.junction/config/genesis.json && \
    curl -s https://snapshots-testnet.nodejumper.io/airchains-testnet/addrbook.json > /root/.junction/config/addrbook.json

# 复制配置文件
COPY config.toml /root/.junction/config/config.toml

# 下载快照并解压
RUN curl -L https://snapshots-testnet.nodejumper.io/airchains-testnet/airchains-testnet_latest.tar.lz4 -o /root/airchains-testnet_latest.tar.lz4 && \
    lz4 -dc /root/airchains-testnet_latest.tar.lz4 | tar -xf - -C /root/.junction

# 设置 priv_validator_state.json 文件
RUN if [ ! -f "/root/.junction/data/priv_validator_state.json" ]; then \
    echo '{"height": "0", "round": 0, "step": 0}' > /root/.junction/data/priv_validator_state.json; \
    fi

# 复制启动脚本到容器中
COPY start.sh /root/start.sh
RUN chmod +x /root/start.sh

# 暴露端口
EXPOSE 26657

# 启动节点
CMD ["/root/start.sh"]
